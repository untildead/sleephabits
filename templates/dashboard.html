{% extends "base.html" %}
{% block content %}
<div class="flex items-center justify-between mb-4">
  <div>
    <h1 class="text-2xl font-semibold text-slate-800">Dashboard</h1>
    <p class="text-sm text-slate-500">Visualiza tendencias de sueño y eficiencia.</p>
  </div>
</div>

<div class="grid md:grid-cols-3 gap-6">
  <!-- Timeseries -->
  <div class="bg-white p-4 rounded shadow md:col-span-3" id="timeseriesCard">
    <h2 class="text-sm uppercase text-slate-500 mb-2">Duración promedio (horas)</h2>
    <div class="relative h-64">
      <canvas id="timeseriesChart" class="absolute inset-0 w-full h-full"></canvas>
    </div>
    <p id="timeseriesEmpty" class="text-sm text-slate-500 mt-2 hidden">No hay datos</p>
  </div>

  <!-- Hábitos y calidad -->
  <div class="bg-white p-4 rounded shadow md:col-span-3" id="habitsCard">
    <h2 class="text-sm uppercase text-slate-500 mb-2">Hábitos y calidad del sueño</h2>
    <div class="relative h-64">
      <canvas id="habitsChart" class="absolute inset-0 w-full h-full"></canvas>
    </div>
    <p id="habitsEmpty" class="text-sm text-slate-500 mt-2 hidden">No hay datos</p>
  </div>
</div>

<script>
const charts = window.sleepCharts || (window.sleepCharts = {});
const baseOpts = { responsive: true, maintainAspectRatio: false };

const toggleEmpty = (id, hasData) => {
  const el = document.getElementById(id);
  if (el) el.classList.toggle('hidden', hasData);
};
const destroyChart = (key) => { if (charts[key]) { charts[key].destroy(); charts[key] = null; } };

// --- Timeseries (promedio diario de horas) ---
const renderTimeseries = (ts) => {
  const daily = Array.isArray(ts.daily) ? [...ts.daily] : [];
  daily.sort((a, b) => new Date(a.date) - new Date(b.date));
  if (!daily.length) { destroyChart('timeseries'); toggleEmpty('timeseriesEmpty', false); return; }
  toggleEmpty('timeseriesEmpty', true);

  const labels = daily.map(p => p.date);
  const data = daily.map(p => Number(p.avg_duration ?? 0));
  const ctx = document.getElementById('timeseriesChart')?.getContext('2d'); if (!ctx) return;
  destroyChart('timeseries');
  charts.timeseries = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: 'Promedio diario (h)', data, tension: 0.25 }] },
    options: baseOpts
  });
};

// --- Hábitos y calidad (promedio eficiencia por tag) ---
const renderHabits = (payload) => {
  const rows = Array.isArray(payload.by_tag) ? payload.by_tag : [];
  if (!rows.length) { destroyChart('habits'); toggleEmpty('habitsEmpty', false); return; }
  toggleEmpty('habitsEmpty', true);

  const labels = rows.map(r => r.tag);
  const effData = rows.map(r => Number(r.avg_efficiency ?? 0));
  const dur = rows.map(r => Number(r.avg_duration ?? 0));
  const counts = rows.map(r => Number(r.n ?? 0));

  const ctx = document.getElementById('habitsChart')?.getContext('2d'); if (!ctx) return;
  destroyChart('habits');
  charts.habits = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Eficiencia (%)', data: effData }] },
    options: {
      ...baseOpts,
      plugins: {
        tooltip: {
          callbacks: {
            label: (context) => {
              const i = context.dataIndex;
              const e = effData[i] ?? 0;
              const h = dur[i] ?? 0;
              const n = counts[i] ?? 0;
              return ` Efic.: ${e.toFixed(1)}%  |  Horas: ${h.toFixed(2)}  |  n=${n}`;
            }
          }
        }
      },
      scales: { y: { beginAtZero: true, max: 100 } }
    }
  });
};

async function loadCharts() {
  try {
    const [tsRes, habitsRes] = await Promise.all([
      fetch('/api/reports/timeseries'),
      fetch('/api/reports/habits_quality'),
    ]);
    if (!tsRes.ok || !habitsRes.ok) throw new Error('No se pudieron cargar los reportes');
    const ts = await tsRes.json();
    const habits = await habitsRes.json();
    renderTimeseries(ts);
    renderHabits(habits);
  } catch (err) {
    console.error(err);
    if (typeof showToast === 'function') showToast('No se pudieron cargar las gráficas', true);
  }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadCharts, { once: true });
} else {
  loadCharts();
}
</script>
{% endblock %}
